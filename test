#!/bin/sh

# Repositories to check

# https://github.com/mondeja/project-config
# https://github.com/mondeja/mdpo

TEMPDIR="/tmp/project-config-styles-tests"

prepareTempdir() {
  if ! [ -d "$TEMPDIR" ]; then
    mkdir "$TEMPDIR"
  fi
}

CHECK_FAIL=0

check() {
  grep '^# https://' "$0" | while read -r _ repo directory; do
    dirname="$(basename "$repo")"
    echo "--- $dirname ---"
    dirpath="$TEMPDIR/$dirname"
    set -e
    if [ -d "$dirpath" ]; then
      cd "$dirpath" || exit 1
      git pull > /dev/null
    else
      git clone --depth=1 "$repo" "$dirpath"
    fi
    cd "$TEMPDIR/$dirname" || exit 1
    pre-commit install > /dev/null
    set +e
    pre-commit run -a project-config || CHECK_FAIL=1
    echo
  done;
}

main() {
  prepareTempdir
  check
  [ "$CHECK_FAIL" -eq 0 ] || exit "$CHECK_FAIL"
}

main
